# VCL Compiler API

The VCL Compiler is responsible for transforming the abstract syntax tree (AST) generated by the VCL Parser into executable JavaScript/TypeScript functions. This document provides a reference for the VCL Compiler API in Fastly.JS.

## Overview

The VCL Compiler consists of several components:

1. **AST Visitor**: Traverses the AST and generates JavaScript code
2. **Code Generator**: Converts VCL expressions and statements to JavaScript
3. **Runtime Linker**: Links the compiled code with the runtime environment

## Importing the Compiler

```typescript
import { compileVCL } from '../src/vcl-compiler';
```

## Basic Usage

```typescript
import { parseVCL } from '../src/vcl-parser';
import { compileVCL } from '../src/vcl-compiler';

// Parse VCL code into an AST
const vclCode = `
  sub vcl_recv {
    set req.http.X-Test = "Hello, World!";
    return(lookup);
  }
`;

const ast = parseVCL(vclCode);

// Compile the AST into executable subroutines
const subroutines = compileVCL(ast);

// Execute a subroutine
const context = createVCLContext();
const result = subroutines.vcl_recv(context);
```

## Compiler API

### compileVCL(ast: VCLProgram): VCLSubroutines

Compiles a VCL AST into executable subroutines.

**Parameters:**
- `ast` (VCLProgram): The AST to compile

**Returns:**
- `VCLSubroutines`: An object containing the compiled subroutines

**Example:**
```typescript
const ast = parseVCL(`
  sub vcl_recv {
    set req.http.X-Test = "Hello, World!";
    return(lookup);
  }
`);

const subroutines = compileVCL(ast);
```

### compileVCLFile(filePath: string): VCLSubroutines

Loads, parses, and compiles a VCL file.

**Parameters:**
- `filePath` (string): The path to the VCL file

**Returns:**
- `VCLSubroutines`: An object containing the compiled subroutines

**Example:**
```typescript
const subroutines = compileVCLFile('./path/to/file.vcl');
```

## VCLSubroutines Interface

The `VCLSubroutines` interface represents the compiled VCL subroutines:

```typescript
interface VCLSubroutines {
  [name: string]: (context: VCLContext) => string;
}
```

Each subroutine is a function that takes a `VCLContext` object and returns a string representing the next action to take (e.g., "lookup", "pass", "deliver").

## Compilation Process

The VCL Compiler follows these steps to compile VCL code:

1. **Parse the VCL code**: Convert the VCL code into an AST
2. **Validate the AST**: Check for semantic errors
3. **Generate JavaScript code**: Convert the AST into JavaScript code
4. **Evaluate the generated code**: Create executable functions
5. **Link with the runtime**: Connect the functions with the runtime environment

## Code Generation

The VCL Compiler generates JavaScript code for each VCL construct:

### Subroutine Declaration

```vcl
sub vcl_recv {
  set req.http.X-Test = "Hello, World!";
  return(lookup);
}
```

Generates:

```javascript
function vcl_recv(context) {
  context.req.http["X-Test"] = "Hello, World!";
  return "lookup";
}
```

### Set Statement

```vcl
set req.http.X-Test = "Hello, World!";
```

Generates:

```javascript
context.req.http["X-Test"] = "Hello, World!";
```

### If Statement

```vcl
if (req.url ~ "^/api/") {
  set req.http.X-API = "true";
  return(pass);
} else {
  return(lookup);
}
```

Generates:

```javascript
if (context.req.url.match(/^\/api\//)) {
  context.req.http["X-API"] = "true";
  return "pass";
} else {
  return "lookup";
}
```

### Function Call

```vcl
set req.http.X-MD5 = digest.hash_md5(req.url);
```

Generates:

```javascript
context.req.http["X-MD5"] = context.std.digest.hash_md5(context.req.url);
```

## Error Handling

The VCL Compiler throws descriptive error messages when it encounters compilation errors:

```typescript
try {
  const ast = parseVCL(`
    sub vcl_recv {
      set req.http.X-Test = unknown_variable;
      return(lookup);
    }
  `);
  
  const subroutines = compileVCL(ast);
} catch (error) {
  console.error(error.message);
  // Output: Unknown identifier: unknown_variable at line 3, column 32
}
```

## Advanced Usage

### Custom Compilation Options

```typescript
import { compileVCL, CompileOptions } from '../src/vcl-compiler';

const options: CompileOptions = {
  strictMode: true,
  optimizationLevel: 2,
  includeDebugInfo: true
};

const subroutines = compileVCL(ast, options);
```

### Incremental Compilation

```typescript
import { createCompiler } from '../src/vcl-compiler';

// Create a compiler instance
const compiler = createCompiler();

// Add subroutines incrementally
compiler.addSubroutine('vcl_recv', vclRecvAst);
compiler.addSubroutine('vcl_deliver', vclDeliverAst);

// Get the compiled subroutines
const subroutines = compiler.getSubroutines();
```

### Custom Runtime Functions

```typescript
import { compileVCL, extendRuntime } from '../src/vcl-compiler';

// Extend the runtime with custom functions
extendRuntime('custom', {
  myFunction: (arg1, arg2) => {
    // Implementation
    return result;
  }
});

// Compile VCL that uses the custom function
const subroutines = compileVCL(`
  sub vcl_recv {
    set req.http.X-Result = custom.myFunction(req.url, "test");
    return(lookup);
  }
`);
```

## Conclusion

The VCL Compiler API provides a powerful way to compile VCL code into executable JavaScript/TypeScript functions. It's the core of Fastly.JS's ability to execute VCL configurations locally.

For more information on the VCL Runtime, see the [VCL Runtime API Reference](./vcl-runtime.md).
